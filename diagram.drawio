<mxfile host="app.diagrams.net" modified="2022-01-06T12:58:56.320Z" agent="5.0 (Windows)" etag="mCHFBACByjupspo6L59-" version="16.2.2" type="github">
  <diagram name="Page-1" id="74e2e168-ea6b-b213-b513-2b3c1d86103e">
    <mxGraphModel dx="868" dy="508" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" background="none" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="ehqzlcscsCSHqdPRzGeW-20" value="&lt;div&gt;&lt;b&gt;create_cq_user(struct mlx5_ib_dev *dev, struct ib_udata *udata, &lt;/b&gt;&lt;/div&gt;&lt;div align=&quot;center&quot;&gt;&lt;b&gt;struct mlx5_ib_cq *cq, int entries, u32 **cqb, int *cqe_size, int &lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;b&gt;*index, int *inlen)&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="560" y="80" width="400" height="660" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-37" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" edge="1" parent="1" source="ehqzlcscsCSHqdPRzGeW-32" target="ehqzlcscsCSHqdPRzGeW-36">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-32" value="&lt;b&gt;mlx5_ib_db_map_user(struct mlx5_ib_ucontext *context, struct ib_udata *udata, unsigned long virt, struct mlx5_db *db)&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1040" y="270" width="400" height="420" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-19" value="&lt;div&gt;&lt;b&gt;mlx5_ib_create_cq(struct ib_cq *ibcq, const struct ib_cq_init_attr *attr, struct ib_udata *udata)&lt;/b&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="440" height="800" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-34" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" edge="1" parent="1" source="ehqzlcscsCSHqdPRzGeW-21" target="ehqzlcscsCSHqdPRzGeW-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-21" value="&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;create_cq_user(dev, udata, cq, entries, &amp;amp;cqb, &amp;amp;cqe_size, &amp;amp;index, &amp;amp;inlen);&lt;/font&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="50" y="270" width="420" height="50" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-29" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" edge="1" parent="1" source="ehqzlcscsCSHqdPRzGeW-24" target="ehqzlcscsCSHqdPRzGeW-28">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-24" value="&lt;div&gt;Pin and DMA map user-space cqe memory&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;ucmdlen = min(udata-&amp;gt;inlen, sizeof(ucmd));&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;ib_copy_from_udata(&amp;amp;ucmd, udata, ucmdlen)&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;cq-&amp;gt;buf.umem = ib_umem_get(&amp;amp;dev-&amp;gt;ib_dev, ucmd.buf_addr, entries * ucmd.cqe_size, IB_ACCESS_LOCAL_WRITE);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="570" y="140" width="380" height="130" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-35" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" edge="1" parent="1" source="ehqzlcscsCSHqdPRzGeW-28" target="ehqzlcscsCSHqdPRzGeW-32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-28" value="&lt;div&gt;Map Doorbell to user-space&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;mlx5_ib_db_map_user(context, udata, ucmd.db_addr, &amp;amp;cq-&amp;gt;db);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="570" y="290" width="380" height="70" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-33" value="&lt;div&gt;Pin and DMA map page if needed and add to DB page list&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font face=&quot;Consolas&quot;&gt;if (page with required VA exists)&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font face=&quot;Consolas&quot;&gt;&lt;span style=&quot;white-space: pre&quot;&gt;	&lt;/span&gt;goto found;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;page = kmalloc(sizeof(*page), GFP_KERNEL);&lt;br&gt;page-&amp;gt;user_virt = (virt &amp;amp; PAGE_MASK);&lt;br&gt;page-&amp;gt;refcnt = 0;&lt;br&gt;page-&amp;gt;umem = ib_umem_get(context-&amp;gt;ibucontext.device, virt &amp;amp; PAGE_MASK, PAGE_SIZE, 0);&lt;br&gt;mmgrab(current-&amp;gt;mm);&lt;br&gt;page-&amp;gt;mm = current-&amp;gt;mm;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;list_add(&amp;amp;page-&amp;gt;list, &amp;amp;context-&amp;gt;db_page_list);&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;found:&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;db-&amp;gt;dma = sg_dma_address(page-&amp;gt;umem-&amp;gt;sg_head.sgl) + (virt &amp;amp; ~PAGE_MASK);&lt;br&gt;db-&amp;gt;u.user_page = page;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1050" y="330" width="380" height="350" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-36" value="&lt;div&gt;&lt;font face=&quot;Helvetica&quot;&gt;Prepare command (mlx5_ifc_create_cq_in_bits)&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font face=&quot;Helvetica&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;cqc = MLX5_ADDR_OF(create_cq_in, *cqb, cq_context);&lt;br&gt;MLX5_SET(cqc, cqc, log_page_size, order_base_2(page_size) - MLX5_ADAPTER_PAGE_SHIFT);&lt;br&gt;MLX5_SET(cqc, cqc, page_offset, page_offset_quantized);&lt;br&gt;if (ucmd.cqe_comp_en == 1) {&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;MLX5_SET(cqc, cqc, cqe_comp_en, 1);&lt;br&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp;MLX5_SET(cqc, cqc, mini_cqe_res_format, mini_cqe_format);&lt;br&gt;}&lt;br&gt;MLX5_SET(create_cq_in, *cqb, uid, context-&amp;gt;devx_uid);&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" vertex="1" parent="1">
          <mxGeometry x="570" y="490" width="380" height="240" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-41" style="edgeStyle=orthogonalEdgeStyle;curved=1;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Consolas;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DConsolas;" edge="1" parent="1" source="ehqzlcscsCSHqdPRzGeW-39" target="ehqzlcscsCSHqdPRzGeW-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ehqzlcscsCSHqdPRzGeW-39" value="&lt;div align=&quot;center&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Initialize &lt;b&gt;&lt;i&gt;mlx5_ib_cq&lt;/i&gt;&lt;/b&gt; structure.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;cq-&amp;gt;ibcq.cqe = entries - 1;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;mutex_init(&amp;amp;cq-&amp;gt;resize_mutex);&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;spin_lock_init(&amp;amp;cq-&amp;gt;lock);&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;cq-&amp;gt;resize_buf = NULL;&lt;/font&gt;&lt;/div&gt;&lt;div align=&quot;left&quot;&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;cq-&amp;gt;resize_umem = NULL:&lt;/font&gt;&lt;/div&gt;&lt;font data-font-src=&quot;https://fonts.googleapis.com/css?family=Consolas&quot; face=&quot;Consolas&quot;&gt;cq-&amp;gt;create_flags = attr-&amp;gt;flags;&lt;br&gt;INIT_LIST_HEAD(&amp;amp;cq-&amp;gt;list_send_qp);&lt;br&gt;INIT_LIST_HEAD(&amp;amp;cq-&amp;gt;list_recv_qp);&lt;/font&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="50" y="90" width="420" height="160" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
